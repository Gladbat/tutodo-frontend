<div class="container mt-4">
  <!-- Barra de búsqueda -->
  <div class="row mb-4">
    <div class="col-md-8 offset-md-2">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-white">
              <i class="bi bi-search"></i>
            </span>
            <input 
              type="text" 
              class="form-control border-start-0" 
              placeholder="Buscar productos..."
              [(ngModel)]="searchKeyword"
              (keyup.enter)="buscarProductos()">
            <button class="btn btn-primary" (click)="buscarProductos()">
              Buscar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Filtros laterales -->
    <div class="col-lg-3 mb-4">
      <div class="card shadow-sm sticky-top" style="top: 20px;">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <button 
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="selectedCategoriaId === null"
              (click)="filtrarPorCategoria(null)">
              <span><i class="bi bi-grid-3x3-gap"></i> Todas las categorías</span>
              <i class="bi bi-chevron-right" *ngIf="selectedCategoriaId === null"></i>
            </button>
            <button 
              *ngFor="let categoria of categorias"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="selectedCategoriaId === categoria.id"
              (click)="filtrarPorCategoria(categoria.id)">
              <span><i class="bi bi-tag"></i> {{ categoria.nombre }}</span>
              <i class="bi bi-chevron-right" *ngIf="selectedCategoriaId === categoria.id"></i>
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Paginación -->
<nav aria-label="Paginación de productos" *ngIf="totalPages > 1 && !isLoading">
  <ul class="pagination justify-content-center mt-4">
    <!-- Primera página -->
    <li class="page-item" [class.disabled]="currentPage === 0">
      <a class="page-link" (click)="cambiarPagina(0)" style="cursor: pointer;">
        <i class="bi bi-chevron-double-left"></i>
      </a>
    </li>

    <!-- Anterior -->
    <li class="page-item" [class.disabled]="currentPage === 0">
      <a class="page-link" (click)="cambiarPagina(currentPage - 1)" style="cursor: pointer;">
        <i class="bi bi-chevron-left"></i> Anterior
      </a>
    </li>

    <!-- Números de página -->
    <li class="page-item" 
        *ngFor="let pagina of getPaginaNumeros()"
        [class.active]="pagina === currentPage">
      <a class="page-link" (click)="cambiarPagina(pagina)" style="cursor: pointer;">
        {{ pagina + 1 }}
      </a>
    </li>

    <!-- Siguiente -->
    <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
      <a class="page-link" (click)="cambiarPagina(currentPage + 1)" style="cursor: pointer;">
        Siguiente <i class="bi bi-chevron-right"></i>
      </a>
    </li>

    <!-- Última página -->
    <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
      <a class="page-link" (click)="cambiarPagina(totalPages - 1)" style="cursor: pointer;">
        <i class="bi bi-chevron-double-right"></i>
      </a>
    </li>
  </ul>

  <!-- Info de paginación -->
  <p class="text-center text-muted">
    Mostrando {{ (currentPage * pageSize) + 1 }} - {{ Math.min((currentPage + 1) * pageSize, totalElements) }} 
    de {{ totalElements }} productos
  </p>
</nav>

    <!-- Lista de productos -->
    <div class="col-lg-9">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
          <i class="bi bi-grid"></i> 
          {{ selectedCategoriaId ? 'Productos filtrados' : 'Todos los productos' }}
        </h3>
        <span class="badge bg-primary">{{ productos.length }} productos</span>
      </div>

      <!-- Loader -->
      <div class="text-center py-5" *ngIf="isLoading">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando productos...</p>
      </div>

      <!-- Grid de productos -->
      <div class="row" *ngIf="!isLoading">
        <div class="col-sm-6 col-lg-4 mb-4" *ngFor="let producto of productos">
          <div class="card h-100 producto-card">
            <!-- Imagen -->
            <div class="position-relative">
              <img 
                [src]="getImageUrl(producto)" 
                class="card-img-top producto-imagen" 
                [alt]="producto.nombre"
                style="height: 250px; object-fit: cover; cursor: pointer;"
                [routerLink]="['/productos', producto.id]">
              
              <!-- Badge de estado -->
              <span class="badge position-absolute top-0 end-0 m-2"
                    [class.bg-success]="producto.estado === 'nuevo'"
                    [class.bg-warning]="producto.estado === 'usado'">
                {{ producto.estado === 'nuevo' ? 'Nuevo' : 'Usado' }}
              </span>

              <!-- Botón favorito -->
              <button 
                class="btn btn-light btn-sm position-absolute top-0 start-0 m-2 rounded-circle"
                (click)="agregarAFavoritos(producto)"
                *ngIf="isLoggedIn() && !isAdmin()"
                title="Agregar a favoritos">
                <i class="bi bi-heart"></i>
              </button>
            </div>
            
            <div class="card-body d-flex flex-column">
              <!-- Título -->
              <h5 class="card-title" [routerLink]="['/productos', producto.id]" style="cursor: pointer;">
                {{ producto.nombre }}
              </h5>
              
              <!-- Categoría -->
              <p class="card-text text-muted small mb-2">
                <i class="bi bi-tag"></i> {{ producto.categoriaNombre }}
              </p>
              
              <!-- Descripción -->
              <p class="card-text flex-grow-1 text-truncate-3">
                {{ producto.descripcion }}
              </p>
              
              <!-- Footer -->
              <div class="mt-auto">
                <!-- Precio -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h4 class="text-primary mb-0">S/ {{ producto.precio }}</h4>
                  <span class="text-muted small" *ngIf="producto.cantidadFavoritos && producto.cantidadFavoritos > 0">
                    <i class="bi bi-heart-fill text-danger"></i> {{ producto.cantidadFavoritos }}
                  </span>
                </div>
                
                <!-- Ubicación -->
                <p class="text-muted small mb-3" *ngIf="producto.direccion">
                  <i class="bi bi-geo-alt"></i> {{ producto.direccion }}
                </p>
                
                <!-- Botones -->
                <div class="d-grid gap-2">
                  <a [routerLink]="['/productos', producto.id]" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> Ver Detalles
                  </a>
                  <button 
                    *ngIf="!isAdmin()"
                    class="btn btn-success btn-sm"
                    (click)="abrirWhatsApp(producto)">
                    <i class="bi bi-whatsapp"></i> Contactar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sin resultados -->
        <div class="col-12" *ngIf="productos.length === 0">
          <div class="alert alert-info text-center py-5">
            <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
            <h4 class="mt-3">No se encontraron productos</h4>
            <p class="mb-0">Intenta buscar con otras palabras clave o selecciona otra categoría</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>