<div class="container-fluid mt-4">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <h5 class="px-3 mb-3">
          <i class="bi bi-shield-check text-danger"></i> Panel Admin
        </h5>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" routerLink="/admin/dashboard">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/admin/usuarios">
              <i class="bi bi-people"></i> Usuarios
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/admin/productos">
              <i class="bi bi-box-seam"></i> Productos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" routerLink="/admin/reportes">
              <i class="bi bi-flag"></i> Reportes
            </a>
          </li>
          <li class="nav-item">
            <hr>
          </li>
          <li class="nav-item">
            <a class="nav-link" routerLink="/">
              <i class="bi bi-arrow-left"></i> Volver al Marketplace
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Gestión de Reportes</h1>
        <span class="badge bg-warning text-dark">{{ reportes.length }} reportes totales</span>
      </div>

      <!-- Loader -->
      <div class="text-center py-5" *ngIf="isLoading">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">Cargando reportes...</p>
      </div>

      <!-- Contenido -->
      <div *ngIf="!isLoading">
        <!-- Selector de vista -->
        <div class="btn-group mb-4" role="group">
          <button 
            type="button" 
            class="btn btn-outline-primary"
            [class.active]="vistaSeleccionada === 'agrupados'"
            (click)="cambiarVista('agrupados')">
            <i class="bi bi-collection"></i> Vista Agrupada
          </button>
          <button 
            type="button" 
            class="btn btn-outline-primary"
            [class.active]="vistaSeleccionada === 'todos'"
            (click)="cambiarVista('todos')">
            <i class="bi bi-list-ul"></i> Todos los Reportes
          </button>
        </div>

        <!-- Vista Agrupada -->
        <div *ngIf="vistaSeleccionada === 'agrupados'">
          <!-- Productos más reportados -->
          <div class="alert alert-warning" *ngIf="reportesAgrupados.length > 0">
            <h5 class="alert-heading">
              <i class="bi bi-exclamation-triangle"></i> Top 5 Productos Más Reportados
            </h5>
            <ul class="mb-0">
              <li *ngFor="let grupo of obtenerProductosMasReportados()">
                <strong>{{ grupo.productoNombre }}</strong>: {{ grupo.cantidadReportes }} reportes
                <button class="btn btn-link btn-sm p-0 ms-2" (click)="verProducto(grupo.productoId)">
                  <i class="bi bi-eye"></i> Ver producto
                </button>
              </li>
            </ul>
          </div>

          <!-- Cards de productos reportados -->
          <div class="row">
            <div class="col-lg-6 mb-4" *ngFor="let grupo of reportesAgrupados">
              <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                  <strong>{{ grupo.productoNombre }}</strong>
                  <span class="badge bg-danger">{{ grupo.cantidadReportes }} reportes</span>
                </div>
                <div class="card-body">
                  <h6 class="mb-3">Razones más comunes:</h6>
                  <ul class="mb-3">
                    <li *ngFor="let razon of grupo.razonesComunes">{{ razon }}</li>
                  </ul>

                  <h6 class="mb-2">Detalles de reportes:</h6>
                  <div class="list-group list-group-flush">
                    <div class="list-group-item p-2" *ngFor="let reporte of grupo.reportes">
                      <small>
                        <strong>{{ reporte.razon }}</strong>
                        <br>
                        <span class="text-muted">Por: {{ reporte.usuarioReportadorNombre }}</span>
                        <br>
                        <span class="text-muted" *ngIf="reporte.comentario">
                          "{{ reporte.comentario }}"
                        </span>
                      </small>
                    </div>
                  </div>

                  <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary" (click)="verProducto(grupo.productoId)">
                      <i class="bi bi-eye"></i> Ver Producto
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sin reportes agrupados -->
          <div class="alert alert-info text-center" *ngIf="reportesAgrupados.length === 0">
            <i class="bi bi-info-circle"></i> No hay reportes agrupados
          </div>
        </div>

        <!-- Vista Todos los Reportes -->
        <div *ngIf="vistaSeleccionada === 'todos'">
          <div class="card shadow">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Razón</th>
                      <th>Comentario</th>
                      <th>Reportado por</th>
                      <th>Fecha</th>
                      <th>Acción</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let reporte of reportes">
                      <td>
                        <strong>{{ reporte.productoNombre }}</strong>
                      </td>
                      <td>
                        <span class="badge bg-warning text-dark">{{ reporte.razon }}</span>
                      </td>
                      <td>
                        <small>{{ reporte.comentario || '-' }}</small>
                      </td>
                      <td>{{ reporte.usuarioReportadorNombre }}</td>
                      <td>{{ reporte.fechaCreacion | date:'dd/MM/yyyy' }}</td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary" (click)="verProducto(reporte.productoId)">
                          <i class="bi bi-eye"></i> Ver
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Sin resultados -->
                <div class="text-center py-4" *ngIf="reportes.length === 0">
                  <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                  <p class="text-muted mt-2">No hay reportes</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal de Detalle de Producto -->
<div class="modal fade show d-block" *ngIf="mostrarModal" 
     tabindex="-1" 
     style="background-color: rgba(0,0,0,0.5);"
     (click)="cerrarModal()">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" 
       (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-box-seam"></i> Detalle del Producto Reportado
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      
      <!-- Loader mientras carga el producto -->
      <div class="modal-body text-center py-5" *ngIf="cargandoProducto">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3">Cargando producto...</p>
      </div>

      <!-- Contenido del producto -->
      <div class="modal-body" *ngIf="!cargandoProducto && productoSeleccionado">
        <div class="row">
          <!-- Galería de Imágenes -->
          <div class="col-md-6 mb-3">
            <div class="card">
              <!-- Imagen Principal -->
              <div class="text-center mb-2">
                <img [src]="imagenSeleccionada" 
                     [alt]="productoSeleccionado.nombre" 
                     class="img-fluid rounded"
                     loading="lazy"
                     style="max-height: 300px; object-fit: contain;">
              </div>

              <!-- Miniaturas -->
              <div class="d-flex gap-2 overflow-auto p-2" *ngIf="getImagenes().length > 1">
                <img *ngFor="let imagen of getImagenes()"
                     [src]="imagen" 
                     [alt]="productoSeleccionado.nombre"
                     class="rounded"
                     loading="lazy"
                     [class.border-primary]="imagenSeleccionada === imagen"
                     [class.border]="imagenSeleccionada === imagen"
                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                     (click)="seleccionarImagen(imagen)">
              </div>
            </div>
          </div>

          <!-- Información del Producto -->
          <div class="col-md-6">
            <!-- Nombre y Estado -->
            <div class="mb-3">
              <h4>{{ productoSeleccionado.nombre }}</h4>
              <div class="d-flex gap-2 mb-2">
                <span class="badge" 
                      [class.bg-success]="productoSeleccionado.estado === 'nuevo'"
                      [class.bg-warning]="productoSeleccionado.estado === 'usado'">
                  {{ productoSeleccionado.estado === 'nuevo' ? 'Nuevo' : 'Usado' }}
                </span>
                <span class="badge bg-success" *ngIf="productoSeleccionado.estaActivo && !productoSeleccionado.vendido && !productoSeleccionado.eliminado">Activo</span>
                <span class="badge bg-warning" *ngIf="!productoSeleccionado.estaActivo && !productoSeleccionado.vendido && !productoSeleccionado.eliminado">Inactivo</span>
                <span class="badge bg-secondary" *ngIf="productoSeleccionado.vendido">Vendido</span>
                <span class="badge bg-danger" *ngIf="productoSeleccionado.eliminado">Eliminado</span>
              </div>
            </div>

            <!-- Precio -->
            <div class="mb-3">
              <h3 class="text-primary mb-0">S/ {{ productoSeleccionado.precio }}</h3>
              <small class="text-muted" *ngIf="productoSeleccionado.cantidadFavoritos && productoSeleccionado.cantidadFavoritos > 0">
                <i class="bi bi-heart-fill text-danger"></i> {{ productoSeleccionado.cantidadFavoritos }} favoritos
              </small>
            </div>

            <!-- Categoría -->
            <div class="mb-2">
              <strong>Categoría:</strong>
              <span class="ms-2"><i class="bi bi-tag"></i> {{ productoSeleccionado.categoriaNombre }}</span>
            </div>

            <!-- Ubicación -->
            <div class="mb-3" *ngIf="productoSeleccionado.direccion">
              <strong>Ubicación:</strong>
              <span class="ms-2"><i class="bi bi-geo-alt"></i> {{ productoSeleccionado.direccion }}</span>
            </div>

            <!-- Vendedor -->
            <div class="card bg-light mb-3">
              <div class="card-body py-2">
                <h6 class="mb-2"><i class="bi bi-person-circle"></i> Vendedor</h6>
                <p class="mb-1 small">
                  <strong>Nombre:</strong> {{ productoSeleccionado.usuarioNombre }}
                </p>
                <p class="mb-0 small">
                  <strong>WhatsApp:</strong> {{ productoSeleccionado.usuarioWhatsapp }}
                </p>
              </div>
            </div>

            <!-- Fechas -->
            <div class="small text-muted">
              <p class="mb-1">
                <i class="bi bi-calendar"></i> Publicado: {{ productoSeleccionado.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
              </p>
              <p class="mb-0">
                <i class="bi bi-clock"></i> Actualizado: {{ productoSeleccionado.fechaActualizacion | date:'dd/MM/yyyy HH:mm' }}
              </p>
            </div>
          </div>
        </div>

        <!-- Descripción -->
        <div class="row mt-3">
          <div class="col-12">
            <h6>Descripción</h6>
            <div class="card bg-light">
              <div class="card-body">
                <p class="mb-0" style="white-space: pre-wrap;">{{ productoSeleccionado.descripcion }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer" *ngIf="!cargandoProducto && productoSeleccionado">
        <button class="btn btn-success" (click)="abrirWhatsApp()">
          <i class="bi bi-whatsapp"></i> Contactar Vendedor
        </button>
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>